name: Build and Deploy - be-ccnu

on:
  push:
    branches:
      - main
    paths:
      - 'be-ccnu/**'
env:
  SERVICE_NAME: be-ccnu  # ðŸ‘ˆ è¿™é‡Œè®¾ç½®çš„æ˜¯å…¨å±€çŽ¯å¢ƒå˜é‡


jobs:
  build-be-ccnu:
    if: github.repository == 'asynccnu/ccnubox-be'
    runs-on: ubuntu-latest
    outputs:
      id: ${{ steps.get-version-id.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get tag or commit id
        id: get-version-id
        uses: iawia002/get-tag-or-commit-id@v1
        with:
          length: 7

      - name: Log in to Aliyun Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}
          registry: ${{ secrets.ALIYUN_REGISTRY }}

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build And Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./${{ env.SERVICE_NAME }}/Dockerfile
          push: true
          tags: ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/ccnubox-${{ env.SERVICE_NAME }}:${{ steps.get-version-id.outputs.id }}

  deploy-on-dev:
    if: github.repository == 'asynccnu/ccnubox-be'
    runs-on: ubuntu-latest
    needs: build-be-ccnu
    steps:
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER }} >> ~/.ssh/known_hosts
      - name: SSH into server and deploy
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER }} << 'EOF'
            set -e
            cd ~/ccnubox_v3

            echo '${{ secrets.ALIYUN_PASSWORD }}' | docker login \
            --username=${{ secrets.ALIYUN_USERNAME }} \
            --password-stdin \
            ${{ secrets.ALIYUN_REGISTRY }}
          
            KEY="${{ env.SERVICE_NAME }}-version"
            VALUE="${{ needs.build-be-ccnu.outputs.id }}"
            SERVICE="${{ env.SERVICE_NAME }}"
          
            if grep -q "^${KEY}=" .env; then
              sed -i "s/^${KEY}=.*/${KEY}=${VALUE}/" .env
            else
              echo "${KEY}=${VALUE}" >> .env
            fi
          
            docker compose pull ${SERVICE}
            docker compose up -d ${SERVICE}
            docker image prune -a -f --filter "until=24h"
          EOF
